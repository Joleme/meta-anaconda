From 4749c5a409cb2c121c575cb15118f1b8ff136d75 Mon Sep 17 00:00:00 2001
From: Hongxu Jia <hongxu.jia@windriver.com>
Date: Sat, 29 Jun 2019 16:15:14 +0800
Subject: [PATCH] tweak search location of new-kernel-pkg

In OE, it locates /sbin rather than /usr/sbin

Upstream-Status: Inappropriate [oe specific]

Signed-off-by: Hongxu Jia <hongxu.jia@windriver.com>
---
 pyanaconda/bootloader/grub2.py    | 2 +-
 pyanaconda/payload/__init__.py    | 2 +-
 pyanaconda/payload/livepayload.py | 4 ++--
 3 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/pyanaconda/bootloader/grub2.py b/pyanaconda/bootloader/grub2.py
index 80b026a..bad0806 100644
--- a/pyanaconda/bootloader/grub2.py
+++ b/pyanaconda/bootloader/grub2.py
@@ -274,7 +274,7 @@ class GRUB2(BootLoader):
         defaults.write("GRUB_DISABLE_RECOVERY=\"true\"\n")
         #defaults.write("GRUB_THEME=\"/boot/grub2/themes/system/theme.txt\"\n")
 
-        if self.use_bls and os.path.exists(util.getSysroot() + "/usr/sbin/new-kernel-pkg"):
+        if self.use_bls and os.path.exists(util.getSysroot() + "/sbin/new-kernel-pkg"):
             log.warning("BLS support disabled due new-kernel-pkg being present")
             self.use_bls = False
 
diff --git a/pyanaconda/payload/__init__.py b/pyanaconda/payload/__init__.py
index 4fb40cb..8b48625 100644
--- a/pyanaconda/payload/__init__.py
+++ b/pyanaconda/payload/__init__.py
@@ -563,7 +563,7 @@ class Payload(metaclass=ABCMeta):
 
         :returns: None
         """
-        if os.path.exists(util.getSysroot() + "/usr/sbin/new-kernel-pkg"):
+        if os.path.exists(util.getSysroot() + "/sbin/new-kernel-pkg"):
             use_dracut = False
         else:
             log.warning("new-kernel-pkg does not exist - grubby wasn't installed? "
diff --git a/pyanaconda/payload/livepayload.py b/pyanaconda/payload/livepayload.py
index 235a3b5..5052977 100644
--- a/pyanaconda/payload/livepayload.py
+++ b/pyanaconda/payload/livepayload.py
@@ -166,7 +166,7 @@ class LiveImagePayload(Payload):
         threadMgr.wait(THREAD_LIVE_PROGRESS)
 
         # Live needs to create the rescue image before bootloader is written
-        if os.path.exists(util.getSysroot() + "/usr/sbin/new-kernel-pkg"):
+        if os.path.exists(util.getSysroot() + "/sbin/new-kernel-pkg"):
             use_nkp = True
         else:
             log.warning("new-kernel-pkg does not exist - grubby wasn't installed?")
@@ -200,7 +200,7 @@ class LiveImagePayload(Payload):
             util.execInSysroot("systemd-machine-id-setup", [])
 
         for kernel in self.kernel_version_list:
-            if not os.path.exists(util.getSysroot() + "/usr/sbin/new-kernel-pkg"):
+            if not os.path.exists(util.getSysroot() + "/sbin/new-kernel-pkg"):
                 log.info("Regenerating BLS info for %s", kernel)
                 util.execInSysroot("kernel-install", ["add",
                                                       kernel,
-- 
2.7.4

